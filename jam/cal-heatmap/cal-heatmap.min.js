/*! cal-heatmap v1.1.1 (Thu Feb 28 2013 23:32:23)
 *  ---------------------------------------------
 *  A module to create calendar heat map to visualise time data series a la github contribution graph
 *  https://github.com/kamisama/cal-heatmap
 *  Licensed under the MIT license
 *  Copyright 2013 Wan Qi Chen
 */
var CalHeatMap=function(){"use strict";var t=this;this.options={id:"cal-heatmap",scales:[10,20,30,40],range:12,cellsize:10,cellpadding:2,format:{date:null,legend:null},onClick:function(){},displayScale:!0,itemName:["item","items"],start:new Date,data:"",loadOnInit:!0,domain:"hour",subDomain:"min"},this._domainType={min:{row:10,column:function(){return 6},position:{x:function(e){return Math.floor(e.getMinutes()/t._domainType.min.row)},y:function(e){return e.getMinutes()%t._domainType.min.row}},format:{date:"%H:%M, %A %B %-e, %Y",legend:"",connector:"at"},extractUnit:function(t){return t.getMinutes()}},hour:{row:6,column:function(e){switch(t.options.domain){case"day":return 4;case"week":return 28;case"month":return 4*t.getEndOfMonth(e).getDate()}},position:{x:function(e){return"month"===t.options.domain?Math.floor(e.getHours()/t._domainType.hour.row)+4*(e.getDate()-1):"week"===t.options.domain?Math.floor(e.getHours()/t._domainType.hour.row)+4*t.getWeekDay(e):Math.floor(e.getHours()/t._domainType.hour.row)},y:function(e){return e.getHours()%t._domainType.hour.row}},format:{date:"%Hh, %A %B %-e, %Y",legend:"%H:00",connector:"at"},extractUnit:function(e){var n=d3.time.format("%H");return e.getFullYear()+""+t.getDayOfYear(e)+n(e)}},day:{row:7,column:function(){switch(t.options.domain){case"year":return 54;case"month":return 5;case"week":return 1}},position:{x:function(e){switch(t.options.domain){case"week":return 0;case"month":return t.getWeekNumber(e)-t.getWeekNumber(new Date(e.getFullYear(),e.getMonth()));case"year":return t.getWeekNumber(e)}},y:function(t){return 0===t.getDay()?6:t.getDay()-1}},format:{date:"%A %B %-e, %Y",legend:"%e %b",connector:"on"},extractUnit:function(e){return e.getFullYear()+""+t.getDayOfYear(e)}},week:{row:1,column:function(e){switch(e=new Date(e),t.options.domain){case"year":return 54;case"month":return t.getWeekNumber(new Date(e.getFullYear(),e.getMonth()+1,0))-t.getWeekNumber(e)}return 1},position:{x:function(e){switch(t.options.domain){case"year":return t.getWeekNumber(e);case"month":return t.getWeekNumber(e)-t.getWeekNumber(new Date(e.getFullYear(),e.getMonth()))-1}},y:function(){return 0}},format:{date:"%B Week #%W",legend:"%B Week #%W",connector:"on"},extractUnit:function(e){return t.getWeekNumber(e)}},month:{row:1,column:function(){return 12},position:{x:function(e){return Math.floor(e.getMonth()/t._domainType.month.row)},y:function(e){return e.getMonth()%t._domainType.month.row}},format:{date:"%B %Y",legend:"%B",connector:"on"},extractUnit:function(t){return t.getMonth()}},year:{row:1,column:function(){return 12},position:{x:function(t){return Math.floor(t.getFullYear()/this._domainType.year.row)},y:function(t){return t.getFullYear()%this._domainType.year.row}},format:{date:"%Y",legend:"%Y",connector:"on"},extractUnit:function(t){return t.getFullYear()}}},this.svg=null,this._domains=[];var e=function(){var e=2*t.options.cellsize;t.formatDate=d3.time.format(t.options.format.date);var n=function(e){return t.options.cellsize*t._domainType[t.options.subDomain].column(e)+t.options.cellpadding*t._domainType[t.options.subDomain].column(e)},o=t.options.cellsize*t._domainType[t.options.subDomain].row+t.options.cellpadding*t._domainType[t.options.subDomain].row+t.options.cellpadding,a=d3.time.format(t.options.format.legend);t._domains=t.getDomain(t.options.start).map(function(t){return t.getTime()}),t.svg=d3.select("#"+t.options.id).append("div").attr("class","graph").selectAll().data(t._domains).enter().append("div").attr("class","graph-domain").style("width",function(t){return n(t)+"px"}).style("height",o+e+"px").style("display","inline-block").append("svg:svg").attr("width",function(t){return n(t)}).attr("height",o+e).append("svg:g").attr("transform","translate(0, 1)"),t.svg.append("svg:text").attr("y",o+e/1.5).attr("class","graph-label").attr("text-anchor","middle").attr("vertical-align","middle").attr("x",function(t){return n(t)/2}).text(function(t){return a(new Date(t))});var i=t.svg.selectAll("rect").data(function(e){return t.getSubDomain(e)}).enter().append("svg:rect").attr("class","graph-rect").attr("width",t.options.cellsize).attr("height",t.options.cellsize).attr("x",function(e){return t.positionSubDomainX(e)}).attr("y",function(e){return t.positionSubDomainY(e)});return i.append("svg:title").text(function(e){return t.formatDate(e)}),t.options.displayScale&&t.displayScale(),t.options.loadOnInit&&t.fill(t.getDatas(t.options.data,new Date(t._domains[0]),new Date(t._domains[t._domains.length-1]))),!0};this.init=function(n){if(null!==n&&void 0!==n&&"undefined"!==n)for(var o in t.options)null!==n[o]&&void 0!==n[o]&&"undefined"!==n[o]&&(t.options[o]=n[o]);return this._domainType.hasOwnProperty(t.options.domain)&&"min"!==t.options.domain?(t.getDomain(t.options.start),null===t.options.format.date&&(t.options.format.date=this._domainType[t.options.subDomain].format.date),null===t.options.format.legend&&(t.options.format.legend=this._domainType[t.options.domain].format.legend),e()):(console.log("The domain name is not valid"),!1)}};CalHeatMap.prototype={onClick:function(t,e){return this.options.onClick(t,e)},formatNumber:d3.format(",d"),displayScale:function(){var t=this;d3.select("#"+this.options.id).append("svg:svg").attr("class","graph-scale").attr("height",this.options.cellsize+2*this.options.cellpadding).selectAll().data(d3.range(0,this.options.scales.length+1)).enter().append("svg:rect").attr("width",this.options.cellsize).attr("height",this.options.cellsize).attr("class",function(t){return"graph-rect q"+(t+1)}).attr("transform",function(e){return"translate("+e*(t.options.cellsize+t.options.cellpadding)+", "+t.options.cellpadding+")"}).append("svg:title").text(function(e){return t.options.scales[e+1],0===e?"less than "+t.options.scales[e]+" "+t.options.itemName[1]:e===t.options.scales.length?"more than "+t.options.scales[e-1]+" "+t.options.itemName[1]:"between "+t.options.scales[e-1]+" and "+t.options.scales[e]+" "+t.options.itemName[1]})},getDayOfYear:d3.time.format("%j"),getWeekNumber:d3.time.format("%W"),getWeekDay:function(t){return 0===t.getDay()?6:t.getDay()-1},getEndOfMonth:function(t){return"number"==typeof t&&(t=new Date(t)),new Date(t.getFullYear(),t.getMonth()+1,0)},getWeekDomain:function(t,e){var n;1===t.getDay()?n=new Date(t.getFullYear(),t.getMonth(),t.getDate()):0===t.getDay()?(n=new Date(t.getFullYear(),t.getMonth(),t.getDate()),n.setDate(n.getDate()-6)):n=new Date(t.getFullYear(),t.getMonth(),t.getDate()-t.getDay()+1);var o=new Date(n);return d3.time.mondays(n,new Date(o.setDate(o.getDate()+7*e)))},getYearDomain:function(t,e){return d3.time.years(new Date(t.getFullYear(),0),new Date(t.getFullYear()+e,0))},getMinuteDomain:function(t,e){var n=new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours());return d3.time.minutes(n,new Date(n.getTime()+6e4*e))},getHourDomain:function(t,e){var n=new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours());return"number"==typeof e&&(e=new Date(n.getTime()+36e5*e)),d3.time.hours(n,e)},getDayDomain:function(t,e){var n=new Date(t.getFullYear(),t.getMonth(),t.getDate()),o=new Date(n);return o=new Date(o.setDate(o.getDate()+parseInt(e,10))),d3.time.days(n,o)},getMonthDomain:function(t,e){var n=new Date(t.getFullYear(),t.getMonth()),o=new Date(n);return o=o.setMonth(o.getMonth()+e),d3.time.months(n,o)},getDomain:function(t){switch("number"==typeof t&&(t=new Date(t)),this.options.domain){case"hour":return this.getHourDomain(t,this.options.range);case"day":return this.getDayDomain(t,this.options.range);case"week":return this.getWeekDomain(t,this.options.range);case"month":return this.getMonthDomain(t,this.options.range);case"year":return this.getYearDomain(t,this.options.range)}},getSubDomain:function(t){"number"==typeof t&&(t=new Date(t));var e=this,n=function(t,n){if("year"===n)return e.getDayOfYear(new Date(t.getFullYear()+1,0,0));if("month"===n){var o=new Date(t.getFullYear(),t.getMonth()+1,0);return o.getDate()}return"week"===n?7:void 0},o=function(t,e){return"day"===e?1440:"hour"===e?60:"week"===e?25200:void 0},a=function(t,e){if("day"===e)return 24;if("week"===e)return 168;if("month"===e){var n=new Date(t.getFullYear(),t.getMonth()+1,0);return 24*n.getDate()}},i=function(t,n){if("month"===n){var o=new Date(t.getFullYear(),t.getMonth()+1,0),a=e.getWeekNumber(o),i=e.getWeekNumber(new Date(t.getFullYear(),t.getMonth()));return i>a&&(i=0,a++),a-i+1}return"year"===n?e.getWeekNumber(new Date(t.getFullYear(),11,31)):void 0};switch(this.options.subDomain){case"min":return this.getMinuteDomain(t,o(t,this.options.domain));case"hour":return this.getHourDomain(t,a(t,this.options.domain));case"day":return this.getDayDomain(t,n(t,this.options.domain));case"week":return this.getWeekDomain(t,i(t,this.options.domain));case"month":return this.getMonthDomain(t,12)}},scale:function(t){for(var e=0,n=this.options.scales.length-1;n>e;e++){if(0===t&&this.options.scales[0]>0)return"";if(this.options.scales[0]>0&&0>t)return"qi";if(this.options.scales[e]>=t)return"q"+(e+1)}return"q"+this.options.scales.length},fill:function(t){t!==!1&&this.display(this.parseDatas(t))},getDatas:function(t,e,n){var o=this;switch(typeof t){case"string":return""===t?!1:(d3.json(this.parseURI(t,e,n),function(t){o.fill(t)}),!0);case"object":return t}return!1},parseDatas:function(t){var e={};for(var n in t){var o=new Date(1e3*n),a=this.getDomain(o)[0].getTime();if(!(0>this._domains.indexOf(a))){var i=this._domainType[this.options.subDomain].extractUnit(o);e[a]===void 0&&(e[a]={}),e[a][i]!==void 0?e[a][i]+=t[n]:e[a][i]=t[n]}}return e},display:function(t){var e=this;this.svg.each(function(n){d3.select(this).selectAll("rect").attr("class",function(o){var a=e._domainType[e.options.subDomain].extractUnit(o);return"graph-rect"+(t.hasOwnProperty(n)&&t[n].hasOwnProperty(a)?" "+e.scale(t[n][a]):"")}).on("click",function(o){var a=e._domainType[e.options.subDomain].extractUnit(o);return e.onClick(o,t.hasOwnProperty(n)&&t[n].hasOwnProperty(a)?t[n][a]:0)}).select("title").text(function(o){var a=e._domainType[e.options.subDomain].extractUnit(o);return(t.hasOwnProperty(n)&&t[n].hasOwnProperty(a)?e.formatNumber(t[n][a])+" "+e.options.itemName[t[n][a]>1?1:0]+" "+e._domainType[e.options.subDomain].format.connector+" ":"")+e.formatDate(o)})})},positionSubDomainX:function(t){var e=this._domainType[this.options.subDomain].position.x(t);return e*this.options.cellsize+e*this.options.cellpadding},positionSubDomainY:function(t){var e=this._domainType[this.options.subDomain].position.y(t);return e*this.options.cellsize+e*this.options.cellpadding},parseURI:function(t,e,n){return t=t.replace(/\{\{t:start\}\}/g,e.getTime()/1e3),t=t.replace(/\{\{t:end\}\}/g,n.getTime()/1e3),t=t.replace(/\{\{d:start\}\}/g,e.toISOString()),t=t.replace(/\{\{d:end\}\}/g,n.toISOString())}},"function"==typeof define&&define.amd&&define(["d3"],function(){return CalHeatMap});